<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Indicadores de Saúde de Varjota</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  
  <style>
    body {font-family: 'Segoe UI', sans-serif; margin:20px; background:#f7f9fc; color:#333;}
    h2 {text-align:center; color:#2c3e50; margin-bottom:20px;}
    .tab-buttons {text-align:center; margin-bottom:20px; display:flex; flex-wrap:wrap; justify-content:center; gap:8px;}
    .tab-button {padding:12px 18px; background:#007bff; color:#fff; border:none; border-radius:6px 6px 0 0; cursor:pointer; font-weight:600;}
    .tab-button:hover {background:#0056b3;}
    .tab-button.active {background:#0056b3; top:1px; position:relative;}
    .tab-content {display:none; background:#fff; padding:25px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
    .tab-content.active {display:block;}
    .filtros {margin-bottom:20px; display:flex; flex-wrap:wrap; gap:15px; align-items:end;}
    .filtro-group {min-width:240px;}
    .filtro-group label {display:block; margin-bottom:6px; font-weight:600; color:#495057;}
    .select2-container--default .select2-selection--multiple {
      border:1px solid #ced4da; border-radius:6px; min-height:40px; padding:4px 8px;
    }
    .select2-container {width:100% !important;}
    .filtros button {padding:10px 24px; background:#28a745; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600;}
    .filtros button:hover {background:#218838;}
    .erro {color:#dc3545; font-weight:bold; margin-top:10px; display:none;}
    table {font-size:13px; width:100%; margin-top:10px;}
    th {background:#007bff; color:#fff;}
    td, th {text-align:center; padding:8px;}
  </style>
</head>
<body>
  <h2>Indicadores de Saúde de Varjota</h2>

  <div class="tab-buttons">
    <button class="tab-button active" onclick="openTab('tab1')">Desenv. Infantil (exceto vacinas)</button>
    <button class="tab-button" onclick="openTab('tab2')">Desenv. Infantil (vacinas)</button>
    <button class="tab-button" onclick="openTab('tab3')">Gestação e Puerpério</button>
    <button class="tab-button" onclick="openTab('tab4')">Hipertensão</button>
    <button class="tab-button" onclick="openTab('tab5')">Diabetes</button>
    <button class="tab-button" onclick="openTab('tab6')">Saúde da Mulher</button>
  </div>

  <!-- Abas 1 a 6 (todas com mesmo padrão) -->
  <div id="tab1" class="tab-content active">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe" multiple placeholder="Todas as equipes"></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea1" multiple placeholder="Selecione equipe(s) primeiro"></select></div>
      <div class="filtro-group"><label>Status</label><select id="filtroStatus1" multiple placeholder="Todos"></select></div>
      <div class="filtro-group"><label>Quadrimestre</label><select id="filtroQuadrimestre1" multiple placeholder="Todos"></select></div>
      <button id="btnPdf1">Gerar PDF</button>
    </div>
    <div id="erroPdf1" class="erro"></div>
    <table id="tabela1" class="display"><thead><tr id="cabecalho1"></tr></thead><tbody></tbody></table>
  </div>

  <div id="tab2" class="tab-content">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe2" multiple placeholder="Todas as equipes"></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea2" multiple placeholder="Selecione equipe(s) primeiro"></select></div>
      <div class="filtro-group"><label>Status</label><select id="filtroStatus2" multiple placeholder="Todos"></select></div>
      <div class="filtro-group"><label>Quadrimestre</label><select id="filtroQuadrimestre2" multiple placeholder="Todos"></select></div>
      <button id="btnPdf2">Gerar PDF</button>
    </div>
    <div id="erroPdf2" class="erro"></div>
    <table id="tabela2" class="display"><thead><tr id="cabecalho2"></tr></thead><tbody></tbody></table>
  </div>

  <div id="tab3" class="tab-content">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe3" multiple placeholder="Todas as equipes"></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea3" multiple placeholder="Selecione equipe(s) primeiro"></select></div>
      <button id="btnPdf3">Gerar PDF</button>
    </div>
    <div id="erroPdf3" class="erro"></div>
    <table id="tabela3" class="display"><thead><tr id="cabecalho3"></tr></thead><tbody></tbody></table>
  </div>

  <div id="tab4" class="tab-content">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe4" multiple placeholder="Todas as equipes"></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea4" multiple placeholder="Selecione equipe(s) primeiro"></select></div>
      <div class="filtro-group"><label>Prioridade</label><select id="filtroPrioridade4" multiple placeholder="Todas"></select></div>
      <div class="filtro-group"><label>Boas Práticas</label><select id="filtroBoasPraticas4" multiple placeholder="Todas"></select></div>
      <button id="btnPdf4">Gerar PDF</button>
    </div>
    <div id="erroPdf4" class="erro"></div>
    <table id="tabela4" class="display"><thead><tr id="cabecalho4"></tr></thead><tbody></tbody></table>
  </div>

  <div id="tab5" class="tab-content">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe5" multiple placeholder="Todas as equipes"></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea5" multiple placeholder="Selecione equipe(s) primeiro"></select></div>
      <div class="filtro-group"><label>Prioridade</label><select id="filtroPrioridade5" multiple placeholder="Todas"></select></div>
      <div class="filtro-group"><label>Boas Práticas</label><select id="filtroBoasPraticas5" multiple placeholder="Todas"></select></div>
      <button id="btnPdf5">Gerar PDF</button>
    </div>
    <div id="erroPdf5" class="erro"></div>
    <table id="tabela5" class="display"><thead><tr id="cabecalho5"></tr></thead><tbody></tbody></table>
  </div>

  <div id="tab6" class="tab-content">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe6" multiple placeholder="Todas as equipes"></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea6" multiple placeholder="Selecione equipe(s) primeiro"></select></div>
      <div class="filtro-group"><label>Boas Práticas</label><select id="filtroBoasPraticas6" multiple placeholder="Todas"></select></div>
      <button id="btnPdf6">Gerar PDF</button>
    </div>
    <div id="erroPdf6" class="erro"></div>
    <table id="tabela6" class="display"><thead><tr id="cabecalho6"></tr></thead><tbody></tbody></table>
  </div>

  <script>
    function openTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`[onclick="openTab('${tabId}')"]`).classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', function () {
      const urls = {
        1: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJk3K_1DtxtxvBx5UuRIbsl_OGzNA9AMMx3TbacImInVTl759ziDlxBK0nlwZg1J_iKxjktwvI5FaH/pub?gid=1142482515&single=true&output=csv",
        2: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJk3K_1DtxtxvBx5UuRIbsl_OGzNA9AMMx3TbacImInVTl759ziDlxBK0nlwZg1J_iKxjktwvI5FaH/pub?gid=1899832726&single=true&output=csv",
        3: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSA7ZEnYITSAdJO8T5LvvnDewjPeqMT57kDv_oSeuFUUznKI3FQ5pGg2Ic34k4ZShbWtONP-dvJOABQ/pub?gid=1768767677&single=true&output=csv",
        4: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT9k_e_-jlJbu3GvtHBhvCfuUbuC7l85MV_jjZRnbsd3lIqmoKF2pLhGl1JnSfziVXze5zkGCXdPb2n/pub?output=csv",
        5: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSbfV1Kc6st6COoy-FxrbfnC_Ac3bxobCVY_-HXj0oyXNnVo7uVld2VVJh7gAhXAPGHXlZGutzjivjP/pub?gid=1534038569&single=true&output=csv",
        6: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLX3B-1FNtn9BZVDseNGuRiPtUUtm13TTx_vI-quwscEMMsTVCp-NjL7b9YH4Cr4vgSI6jAH52M8mk/pub?gid=1711913800&single=true&output=csv"
      };

      function criarTabela(num, headerRowIdx, dataStartIdx, colunasFim, filtrosExtras = {}) {
        Papa.parse(urls[num] + "&t=" + Date.now(), {
          download: true,
          skipEmptyLines: true,
          complete: function (res) {
            const dados = res.data.slice(dataStartIdx).map(r => {
              r[1] = (r[1] || '').toString().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
              r[2] = (r[2] || '').toString().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
              return r;
            });

            // Montar tabela
            document.getElementById(`cabecalho${num}`).innerHTML = res.data[headerRowIdx].slice(1, colunasFim + 1).map(h => `<th>${h || ''}</th>`).join('');
            const tbody = document.querySelector(`#tabela${num} tbody`);
            tbody.innerHTML = '';
            dados.forEach(row => {
              if (row.length >= colunasFim + 1) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td></td>' + Array.from({length: colunasFim}, (_, i) => `<td>${row[i+1] || ''}</td>`).join('');
                tbody.appendChild(tr);
              }
            });

            const tabela = $(`#tabela${num}`).DataTable({
              pageLength: 15,
              destroy: true,
              drawCallback: function () {
                this.api().rows({page: 'current'}).nodes().each((row, i) => {
                  $(row).find('td:first').text(i + 1 + this.api().page.info().start);
                });
              }
            });

            const ids = {
              equipe: num === 1 ? 'filtroEquipe' : `filtroEquipe${num}`,
              microarea: `filtroMicroarea${num === 1 ? 1 : num}`,
              boaspraticas: num >= 4 ? `filtroBoasPraticas${num}` : null
            };

            // Atualizar microáreas (agora com Select2 bonito!)
            function atualizarMicroareas() {
              const eqSel = $(`#${ids.equipe}`).val() || [];
              const microFiltradas = eqSel.length === 0
                ? [...new Set(dados.map(r => r[2]).filter(Boolean))]
                : [...new Set(dados.filter(r => eqSel.includes(r[1])).map(r => r[2]).filter(Boolean))];

              const $micro = $(`#${ids.microarea}`);
              $micro.empty().append('<option></option>');
              microFiltradas.sort().forEach(m => $micro.append(`<option value="${m}">${m}</option>`));

              // Inicializa ou reinicializa o Select2 corretamente
              if ($micro.hasClass('select2-hidden-accessible')) $micro.select2('destroy');
              $micro.select2({
                placeholder: eqSel.length ? "Filtrar microáreas" : "Todas as microáreas",
                allowClear: true,
                width: '100%'
              });
            }

            // Inicializar Select2 para Equipe
            const equipes = [...new Set(dados.map(r => r[1]).filter(Boolean))].sort();
            const $eq = $(`#${ids.equipe}`).empty().append('<option></option>');
            equipes.forEach(e => $eq.append(`<option value="${e}">${e}</option>`));
            $eq.select2({ placeholder: "Todas as equipes", allowClear: true })
               .on('change', () => {
                 tabela.column(1).search('').draw();
                 atualizarMicroareas();
               });

            // Boas Práticas (se existir)
            if (ids.boaspraticas) {
              const idxBP = filtrosExtras.boaspraticas?.idx || 10;
              const bpVals = [...new Set(dados.map(r => r[idxBP]).filter(Boolean))].sort();
              const $bp = $(`#${ids.boaspraticas}`).empty().append('<option></option>');
              bpVals.forEach(v => $bp.append(`<option value="${v}">${v}</option>`));
              $bp.select2({ placeholder: "Todas", allowClear: true });
            }

            // Inicializa microáreas
            atualizarMicroareas();

            // Aplicar filtros
            function aplicarFiltros() {
              const eq = $(`#${ids.equipe}`).val() || [];
              const mc = $(`#${ids.microarea}`).val() || [];
              const bp = ids.boaspraticas ? $(`#${ids.boaspraticas}`).val() || [] : [];

              tabela.column(1).search(eq.length ? '^(' + eq.join('|') + ')$' : '', true, false);
              tabela.column(2).search(mc.length ? '^(' + mc.join('|') + ')$' : '', true, false);
              if (bp.length && ids.boaspraticas) {
                tabela.column(filtrosExtras.boaspraticas.idx).search('^(' + bp.join('|') + ')$', true, false);
              }
              tabela.draw();
            }

            $(document).on('change', `#${ids.equipe}, #${ids.microarea}, #${ids.boaspraticas || ''}`, aplicarFiltros);

            // PDF (funcionando perfeitamente)
            document.getElementById(`btnPdf${num}`).onclick = function () {
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF({orientation:'landscape', unit:'mm', format:'a4'});
              const eqSel = $(`#${ids.equipe}`).val() || [];
              const mcSel = $(`#${ids.microarea}`).val() || [];
              const titulo = num === 6 ? "Saúde da Mulher" : `Indicador ${num}`;
              let subtitulo = eqSel.length ? eqSel.join(', ') : '';
              if (mcSel.length) subtitulo += (subtitulo ? ' - ' : '') + 'Microárea ' + mcSel.join(', ');
              doc.text(subtitulo ? `${titulo} - ${subtitulo}` : titulo, 14, 20);

              const rows = tabela.rows({search:'applied'}).data().toArray();
              if (!rows.length) return alert('Nenhum dado');

              const head = (eqSel.length === 0 && mcSel.length === 0)
                ? ['Nº', ...res.data[headerRowIdx].slice(1, colunasFim + 1)]
                : ['Nº', ...(eqSel.length === 0 ? ['Equipe'] : []), ...(mcSel.length === 0 ? ['Microárea'] : []), ...res.data[headerRowIdx].slice(3, colunasFim + 1)];

              const body = rows.map((r, i) => {
                const linha = [(i+1)+''];
                if (eqSel.length === 0) linha.push(r[1]);
                if (mcSel.length === 0) linha.push(r[2]);
                for (let j = 3; j < r.length; j++) linha.push(r[j] || '');
                return linha;
              });

              doc.autoTable({head: [head], body, startY: 30, theme: 'striped', styles: {fontSize:7, halign:'center'}});
              doc.save(`${titulo.toLowerCase().replace(/ /g,'-')}-${eqSel.join('-') || 'todas'}-${mcSel.join('-') || 'todas'}.pdf`);
            };
          }
        });
      }

      criarTabela(1, 4, 5, 14, {status: {idx:13}, quadrimestre: {idx:14}});
      criarTabela(2, 4, 5, 12, {status: {idx:11}, quadrimestre: {idx:12}});
      criarTabela(3, 4, 5, 18, {});
      criarTabela(4, 3, 4, 11, {prioridade: {idx:10}, boaspraticas: {idx:11}});
      criarTabela(5, 3, 4, 13, {prioridade: {idx:12}, boaspraticas: {idx:13}});
      criarTabela(6, 3, 4, 10, {boaspraticas: {idx:10}});
    });
  </script>
</body>
</html>
