<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Indicadores de Saúde de Varjota</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
  
  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  
  <!-- jsPDF + autoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
  
  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  
  <style>
    body {font-family: 'Segoe UI', sans-serif; margin:20px; background:#f7f9fc; color:#333;}
    h2 {text-align:center; color:#2c3e50; margin-bottom:20px;}
    .tab-buttons {text-align:center; margin-bottom:20px;}
    .tab-button {
      padding:12px 20px; background:#007bff; color:#fff; border:none;
      border-radius:6px 6px 0 0; cursor:pointer; margin:0 4px; font-weight:600;
    }
    .tab-button:hover {background:#0056b3;}
    .tab-button.active {background:#0056b3;}
    .tab-content {display:none; background:#fff; padding:25px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
    .tab-content.active {display:block;}
    .filtros {margin-bottom:20px; display:flex; flex-wrap:wrap; gap:15px; align-items:end;}
    .filtro-group {min-width:220px;}
    .filtro-group label {display:block; margin-bottom:5px; font-weight:600; color:#495057;}
    .select2-container {width:100% !important;}
    .select2-container--default .select2-selection--multiple {
      border:1px solid #ced4da; border-radius:6px; min-height:38px; padding:4px;
    }
    .filtros button {
      padding:10px 20px; background:#28a745; color:#fff; border:none;
      border-radius:6px; cursor:pointer; font-weight:600;
    }
    .filtros button:hover {background:#218838;}
    .erro {color:#dc3545; font-weight:bold; margin-top:10px; display:none;}
    table {font-size:13px; width:100%;}
    th {background:#007bff; color:#fff;}
    td, th {text-align:center; padding:6px;}
  </style>
</head>
<body>
  <h2>Indicadores de Saúde de Varjota</h2>

  <div class="tab-buttons">
    <button class="tab-button active" onclick="openTab('tab1')">Desenv. Infantil (exceto vacinas)</button>
    <button class="tab-button" onclick="openTab('tab2')">Desenv. Infantil (vacinas)</button>
    <button class="tab-button" onclick="openTab('tab3')">Gestação e Puerpério</button>
    <button class="tab-button" onclick="openTab('tab4')">Hipertensão</button>
    <button class="tab-button" onclick="openTab('tab5')">Diabetes</button>
  </div>

  <!-- Aba 1 -->
  <div id="tab1" class="tab-content active">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe" multiple placeholder="Todas"></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea1" multiple placeholder="Todas"></select></div>
      <div class="filtro-group"><label>Status</label><select id="filtroStatus1" multiple placeholder="Todos"></select></div>
      <div class="filtro-group"><label>Quadrimestre</label><select id="filtroQuadrimestre1" multiple placeholder="Todos"></select></div>
      <button id="btnPdf1">Gerar PDF</button>
    </div>
    <div id="erroPdf" class="erro"></div>
    <table id="tabela1" class="display"><thead><tr id="cabecalho1"></tr></thead><tbody></tbody></table>
  </div>

  <!-- Aba 2 -->
  <div id="tab2" class="tab-content">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe2" multiple placeholder="Todas"></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea2" multiple placeholder="Todas"></select></div>
      <div class="filtro-group"><label>Status</label><select id="filtroStatus2" multiple placeholder="Todos"></select></div>
      <div class="filtro-group"><label>Quadrimestre</label><select id="filtroQuadrimestre2" multiple placeholder="Todos"></select></div>
      <button id="btnPdf2">Gerar PDF</button>
    </div>
    <div id="erroPdf2" class="erro"></div>
    <table id="tabela2" class="display"><thead><tr id="cabecalho2"></tr></thead><tbody></tbody></table>
  </div>

  <!-- Aba 3 -->
  <div id="tab3" class="tab-content">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe3" multiple placeholder="Todas"></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea3" multiple placeholder="Todas"></select></div>
      <button id="btnPdf3">Gerar PDF</button>
    </div>
    <div id="erroPdf3" class="erro"></div>
    <table id="tabela3" class="display"><thead><tr id="cabecalho3"></tr></thead><tbody></tbody></table>
  </div>

  <!-- Aba 4 - Hipertensão -->
  <div id="tab4" class="tab-content">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe4" multiple placeholder="Todas"></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea4" multiple placeholder="Todas"></select></div>
      <div class="filtro-group"><label>Prioridade</label><select id="filtroPrioridade4" multiple placeholder="Todas"></select></div>
      <div class="filtro-group"><label>Boas Práticas</label><select id="filtroBoasPraticas4" multiple placeholder="Todas"></select></div>
      <button id="btnPdf4">Gerar PDF</button>
    </div>
    <div id="erroPdf4" class="erro"></div>
    <table id="tabela4" class="display"><thead><tr id="cabecalho4"></tr></thead><tbody></tbody></table>
  </div>

  <!-- Aba 5 - Diabetes -->
  <div id="tab5" class="tab-content">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe5" multiple placeholder="Todas"></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea5" multiple placeholder="Todas"></select></div>
      <div class="filtro-group"><label>Prioridade</label><select id="filtroPrioridade5" multiple placeholder="Todas"></select></div>
      <div class="filtro-group"><label>Boas Práticas</label><select id="filtroBoasPraticas5" multiple placeholder="Todas"></select></div>
      <button id="btnPdf5">Gerar PDF</button>
    </div>
    <div id="erroPdf5" class="erro"></div>
    <table id="tabela5" class="display"><thead><tr id="cabecalho5"></tr></thead><tbody></tbody></table>
  </div>

  <script>
    function openTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`[onclick="openTab('${tabId}')"]`).classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', function () {
      const urls = {
        1: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJk3K_1DtxtxvBx5UuRIbsl_OGzNA9AMMx3TbacImInVTl759ziDlxBK0nlwZg1J_iKxjktwvI5FaH/pub?gid=1142482515&single=true&output=csv",
        2: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJk3K_1DtxtxvBx5UuRIbsl_OGzNA9AMMx3TbacImInVTl759ziDlxBK0nlwZg1J_iKxjktwvI5FaH/pub?gid=1899832726&single=true&output=csv",
        3: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSA7ZEnYITSAdJO8T5LvvnDewjPeqMT57kDv_oSeuFUUznKI3FQ5pGg2Ic34k4ZShbWtONP-dvJOABQ/pub?gid=1768767677&single=true&output=csv",
        4: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT9k_e_-jlJbu3GvtHBhvCfuUbuC7l85MV_jjZRnbsd3lIqmoKF2pLhGl1JnSfziVXze5zkGCXdPb2n/pub?output=csv",
        5: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSbfV1Kc6st6COoy-FxrbfnC_Ac3bxobCVY_-HXj0oyXNnVo7uVld2VVJh7gAhXAPGHXlZGutzjivjP/pub?gid=1534038569&single=true&output=csv"
      };

      function criarTabela(num, headerRowIdx, dataStartIdx, colunasFim, filtros = {}) {
        Papa.parse(urls[num] + "&t=" + Date.now(), {
          download: true,
          skipEmptyLines: true,
          complete: function (res) {
            const cabecalhoGlobal = ['Nº', ...res.data[headerRowIdx].slice(1, colunasFim + 1)];
            let dados = res.data.slice(dataStartIdx);

            // Normalizar todas as colunas de filtro (incluindo microárea na coluna C → índice 2)
            Object.keys(filtros).forEach(k => {
              const idx = filtros[k].idx;
              dados = dados.map(r => {
                r[idx] = (r[idx] || '').toString().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
                return r;
              });
            });

            // Cabeçalho
            document.getElementById(`cabecalho${num}`).innerHTML = cabecalhoGlobal.map(h => `<th>${h || 'Sem Nome'}</th>`).join('');

            // Corpo
            const tbody = document.querySelector(`#tabela${num} tbody`);
            tbody.innerHTML = '';
            dados.forEach(row => {
              if (row.length >= colunasFim + 1) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td></td>' + Array.from({length: colunasFim}, (_, i) => `<td>${row[i+1] || ''}</td>`).join('');
                tbody.appendChild(tr);
              }
            });

            const tabela = $(`#tabela${num}`).DataTable({
              pageLength: 10,
              destroy: true,
              drawCallback: function () {
                this.api().rows({page: 'current'}).nodes().each((row, i) => {
                  $(row).find('td:first').text(i + 1 + this.api().page.info().start);
                });
              }
            });

            // IDs dos filtros
            const ids = {
              equipe:       num === 1 ? 'filtroEquipe' : `filtroEquipe${num}`,
              microarea:   num === 1 ? 'filtroMicroarea' : `filtroMicroarea${num}`,
              status:       num <= 2 ? `filtroStatus${num}` : null,
              quadrimestre: num <= 2 ? `filtroQuadrimestre${num}` : null,
              prioridade:   num >= 4 ? `filtroPrioridade${num}` : null,
              boaspraticas: num >= 4 ? `filtroBoasPraticas${num}` : null
            };

            // Inicializar Select2 para todos os filtros (incluindo microárea)
            const todosFiltros = { ...filtros, microarea: { idx: 2 } }; // coluna C = microárea
            Object.keys(todosFiltros).forEach(key => {
              const id = ids[key];
              if (id) {
                const valores = [...new Set(dados.map(r => r[todosFiltros[key].idx]).filter(Boolean))].sort();
                const $select = $(`#${id}`).empty();
                valores.forEach(v => $select.append(`<option value="${v}">${v}</option>`));
                $select.select2({
                  placeholder: key === 'microarea' ? "Todas as microáreas" : "Todas",
                  allowClear: true,
                  width: '100%'
                });
              }
            });

            // Aplicar filtros múltiplos
            const eventos = [
              { el: `#${ids.equipe}`, col: 1 },
              { el: `#${ids.microarea}`, col: 2 },
              ...(filtros.status ? [{ el: `#${ids.status}`, col: filtros.status.idx }] : []),
              ...(filtros.quadrimestre ? [{ el: `#${ids.quadrimestre}`, col: filtros.quadrimestre.idx }] : []),
              ...(filtros.prioridade ? [{ el: `#${ids.prioridade}`, col: filtros.prioridade.idx }] : []),
              ...(filtros.boaspraticas ? [{ el: `#${ids.boaspraticas}`, col: filtros.boaspraticas.idx }] : [])
            ];

            eventos.forEach(ev => {
              $(ev.el).on('change', function () {
                const vals = $(this).val() || [];
                const regex = vals.length ? '^(' + vals.map(v => v.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|') + ')$' : '';
                tabela.column(ev.col).search(regex, true, false).draw();
              });
            });

            // PDF
            document.getElementById(`btnPdf${num}`).onclick = function () {
              if (typeof window.jspdf === 'undefined') return alert('jsPDF não carregou');

              const { jsPDF } = window.jspdf;
              const doc = new jsPDF({orientation:'landscape', unit:'mm', format:'a4'});

              const equipeSel = $(`#${ids.equipe}`).val() || [];
              const microSel = $(`#${ids.microarea}`).val() || [];
              const tituloBase = ['','Desenv. Infantil (exceto vacinas)','Desenv. Infantil (vacinas)','Gestação e Puerpério','Hipertensão','Diabetes'][num]

              let titulo = tituloBase;
              if (equipeSel.length > 0) titulo += ` - Equipe ${equipeSel.join(', ')}`;
              if (microSel.length > 0) titulo += ` - Microárea ${microSel.join(', ')}`;

              doc.text(titulo.length > 80 ? titulo.substring(0,77) + '...' : titulo, 14, 20);

              const rows = tabela.rows({search:'applied'}).data().toArray();
              if (rows.length === 0) return alert('Nenhum dado para gerar PDF');

              const head = (equipeSel.length === 0 && microSel.length === 0) ? cabecalhoGlobal : ['Nº', ...cabecalhoGlobal.slice(microSel.length === 0 ? 2 : 3)];
              const body = rows.map((r, i) => {
                const linha = [(i+1).toString()];
                if (equipeSel.length === 0) linha.push(r[1]);
                if (microSel.length === 0) linha.push(r[2]);
                for (let j = microSel.length === 0 ? 3 : 2; j < r.length; j++) linha.push(r[j] || '');
                return linha;
              });

              doc.autoTable({head: [head], body, startY: 30, theme: 'striped', styles: {fontSize:7, halign:'center'}});
              doc.save(`${tituloBase.toLowerCase().replace(/[^a-z0-9]/g,'-')}-${equipeSel.join('-') || 'todas'}-${microSel.join('-') || 'todas'}.pdf`);
            };
          }
        });
      }

      // Criar todas as tabelas com filtro por microárea
      criarTabela(1, 4, 5, 14, {equipe:{idx:1}, status:{idx:12}, quadrimestre:{idx:14}});
      criarTabela(2, 4, 5, 12, {equipe:{idx:1}, status:{idx:11}, quadrimestre:{idx:12}});
      criarTabela(3, 4, 5, 18, {equipe:{idx:1}});
      criarTabela(4, 3, 4, 11, {equipe:{idx:1}, prioridade:{idx:10}, boaspraticas:{idx:11}});
      criarTabela(5, 3, 4, 13, {equipe:{idx:1}, prioridade:{idx:12}, boaspraticas:{idx:13}});
    });
  </script>
</body>
</html>
