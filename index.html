<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Indicadores de Saúde de Varjota</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    body {font-family: 'Segoe UI', sans-serif; margin:20px; background:#f7f9fc; color:#333;}
    h2 {text-align:center; color:#2c3e50; margin-bottom:20px;}
    .tab-buttons {text-align:center; margin-bottom:20px; display:flex; flex-wrap:wrap; justify-content:center; gap:8px;}
    .tab-button {padding:10px 18px; background:#007bff; color:#fff; border:none; border-radius:6px 6px 0 0; cursor:pointer; font-weight:600;}
    .tab-button:hover {background:#0056b3;}
    .tab-button.active {background:#0056b3;}
    .tab-content {display:none; background:#fff; padding:25px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
    .tab-content.active {display:block;}
    .filtros {margin-bottom:20px; display:flex; flex-wrap:wrap; gap:15px; align-items:end;}
    .filtro-group {min-width:220px;}
    .filtro-group label {display:block; margin-bottom:5px; font-weight:600;}
    .select2-container {width:100% !important;}
    .filtros button {padding:10px 20px; background:#28a745; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600;}
    .filtros button:hover {background:#218838;}
    table {font-size:13px; width:100%; margin-top:10px;}
    th {background:#007bff; color:#fff;}
    td, th {text-align:center; padding:6px;}
    table.dataTable thead th {
      text-align: center !important;
      vertical-align: middle !important;
      white-space: normal;
      line-height: 1.3;
      padding: 10px 8px !important;
    }
  </style>
</head>
<body>
  <h2>Indicadores de Saúde de Varjota</h2>
  <div class="tab-buttons">
    <button class="tab-button active" onclick="openTab('tab1')">Desenv. Infantil (exceto vacinas)</button>
    <button class="tab-button" onclick="openTab('tab2')">Desenv. Infantil (vacinas)</button>
    <button class="tab-button" onclick="openTab('tab3')">Gestação e Puerpério</button>
    <button class="tab-button" onclick="openTab('tab4')">Hipertensão</button>
    <button class="tab-button" onclick="openTab('tab5')">Diabetes</button>
    <button class="tab-button" onclick="openTab('tab6')">Saúde da Mulher</button>
    <button class="tab-button" onclick="openTab('tab7')">Nova Tabela</button>
  </div>

  <!-- Aba 1 -->
  <div id="tab1" class="tab-content active">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe" multiple></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea1" multiple></select></div>
      <div class="filtro-group"><label>Status</label><select id="filtroStatus1" multiple></select></div>
      <div class="filtro-group"><label>Quadrimestre</label><select id="filtroQuadrimestre1" multiple></select></div>
      <button id="btnPdf1">Gerar PDF</button>
    </div>
    <table id="tabela1" class="display"><thead><tr id="cabecalho1"></tr></thead><tbody></tbody></table>
  </div>
  <!-- Aba 2 -->
  <div id="tab2" class="tab-content">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe2" multiple></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea2" multiple></select></div>
      <div class="filtro-group"><label>Status</label><select id="filtroStatus2" multiple></select></div>
      <div class="filtro-group"><label>Quadrimestre</label><select id="filtroQuadrimestre2" multiple></select></div>
      <button id="btnPdf2">Gerar PDF</button>
    </div>
    <table id="tabela2" class="display"><thead><tr id="cabecalho2"></tr></thead><tbody></tbody></table>
  </div>
  <!-- Aba 3 - Gestação e Puerpério (com filtro ≥ e ≤) -->
  <div id="tab3" class="tab-content">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe3" multiple></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea3" multiple></select></div>
     
      <div class="filtro-group">
        <label>Idade Gestacional</label>
        <div style="display:flex; gap:10px; align-items:center;">
          <input type="number" id="idadeGestMaior" placeholder="≥" style="width:90px;" title="Maior ou igual a">
          <span>e</span>
          <input type="number" id="idadeGestMenor" placeholder="≤" style="width:90px;" title="Menor ou igual a">
        </div>
      </div>
     
      <button id="btnPdf3">Gerar PDF</button>
    </div>
    <table id="tabela3" class="display"><thead><tr id="cabecalho3"></tr></thead><tbody></tbody></table>
  </div>
  <!-- Aba 4 -->
  <div id="tab4" class="tab-content">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe4" multiple></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea4" multiple></select></div>
      <div class="filtro-group"><label>Prioridade</label><select id="filtroPrioridade4" multiple></select></div>
      <div class="filtro-group"><label>Boas Práticas</label><select id="filtroBoasPraticas4" multiple></select></div>
      <button id="btnPdf4">Gerar PDF</button>
    </div>
    <table id="tabela4" class="display"><thead><tr id="cabecalho4"></tr></thead><tbody></tbody></table>
  </div>
  <!-- Aba 5 -->
  <div id="tab5" class="tab-content">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe5" multiple></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea5" multiple></select></div>
      <div class="filtro-group"><label>Prioridade</label><select id="filtroPrioridade5" multiple></select></div>
      <div class="filtro-group"><label>Boas Práticas</label><select id="filtroBoasPraticas5" multiple></select></div>
      <button id="btnPdf5">Gerar PDF</button>
    </div>
    <table id="tabela5" class="display"><thead><tr id="cabecalho5"></tr></thead><tbody></tbody></table>
  </div>
  <!-- Aba 6 -->
  <div id="tab6" class="tab-content">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe6" multiple></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea6" multiple></select></div>
      <div class="filtro-group"><label>Prioridade</label><select id="filtroPrioridade6" multiple></select></div>
      <div class="filtro-group"><label>Boas Práticas</label><select id="filtroBoasPraticas6" multiple></select></div>
      <button id="btnPdf6">Gerar PDF</button>
    </div>
    <table id="tabela6" class="display"><thead><tr id="cabecalho6"></tr></thead><tbody></tbody></table>
  </div>

  <!-- Aba 7 -->
  <div id="tab7" class="tab-content">
    <div class="filtros">
      <div class="filtro-group"><label>Equipe</label><select id="filtroEquipe7" multiple></select></div>
      <div class="filtro-group"><label>Microárea</label><select id="filtroMicroarea7" multiple></select></div>
      <div class="filtro-group"><label>Prioridade</label><select id="filtroPrioridade7" multiple></select></div>
      <button id="btnPdf7">Gerar PDF</button>
    </div>
    <table id="tabela7" class="display"><thead><tr id="cabecalho7"></tr></thead><tbody></tbody></table>
  </div>

  <script>
    function openTab(id) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelector(`[onclick="openTab('${id}')"]`).classList.add('active');
    }
    const urls = {
      1: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJk3K_1DtxtxvBx5UuRIbsl_OGzNA9AMMx3TbacImInVTl759ziDlxBK0nlwZg1J_iKxjktwvI5FaH/pub?gid=1142482515&single=true&output=csv",
      2: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJk3K_1DtxtxvBx5UuRIbsl_OGzNA9AMMx3TbacImInVTl759ziDlxBK0nlwZg1J_iKxjktwvI5FaH/pub?gid=1899832726&single=true&output=csv",
      3: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSA7ZEnYITSAdJO8T5LvvnDewjPeqMT57kDv_oSeuFUUznKI3FQ5pGg2Ic34k4ZShbWtONP-dvJOABQ/pub?gid=1768767677&single=true&output=csv",
      4: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT9k_e_-jlJbu3GvtHBhvCfuUbuC7l85MV_jjZRnbsd3lIqmoKF2pLhGl1JnSfziVXze5zkGCXdPb2n/pub?output=csv",
      5: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSbfV1Kc6st6COoy-FxrbfnC_Ac3bxobCVY_-HXj0oyXNnVo7uVld2VVJh7gAhXAPGHXlZGutzjivjP/pub?gid=1534038569&single=true&output=csv",
      6: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLX3B-1FNtn9BZVDseNGuRiPtUUtm13TTx_vI-quwscEMMsTVCp-NjL7b9YH4Cr4vgSI6jAH52M8mk/pub?gid=1711913800&single=true&output=csv",
      7: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsrC8_qNUsaD2Yem4lAii-GtidlqdFcR65dSpjEKxv5u6Xwv2cH11_EkkYzxDFGYAB6d5fbcCN1mMo/pub?gid=1534038569&single=true&output=csv"
    };
    function criarTabela(num, headerRowIdx, dataStartIdx, totalCols, filtros = {}) {
      Papa.parse(urls[num] + "&t=" + Date.now(), {
        download: true,
        skipEmptyLines: true,
        complete: function(res) {
          const cabecalhosReais = res.data[headerRowIdx].slice(1, totalCols + 1);
          const cabecalhosTabela = ['Nº', ...cabecalhosReais];
          document.getElementById(`cabecalho${num}`).innerHTML = cabecalhosTabela.map(h => `<th>${h||'Sem nome'}</th>`).join('');
          let dados = res.data.slice(dataStartIdx);
          Object.values(filtros).forEach(f => {
            dados.forEach(r => r[f.idx] = (r[f.idx]||'').toString().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase());
          });
          const tbody = document.querySelector(`#tabela${num} tbody`);
          tbody.innerHTML = '';
          dados.forEach(row => {
            if (row.length >= totalCols + 1) {
              const tr = document.createElement('tr');
              tr.innerHTML = '<td></td>' + Array.from({length: totalCols}, (_,i) => `<td>${row[i+1]||''}</td>`).join('');
              tbody.appendChild(tr);
            }
          });
          const tabela = $(`#tabela${num}`).DataTable({
            pageLength: 10,
            destroy: true,
            drawCallback: function() {
              this.api().rows({page:'current'}).nodes().each((row,i) => {
                $(row).find('td:first').text(i + 1 + this.api().page.info().start);
              });
            }
          });
          const ids = {
            equipe: num === 1 ? 'filtroEquipe' : `filtroEquipe${num}`,
            microarea: `filtroMicroarea${num === 1 ? 1 : num}`,
            status: num <= 2 ? `filtroStatus${num}` : null,
            quadrimestre: num <= 2 ? `filtroQuadrimestre${num}` : null,
            prioridade: (num >= 4 && num <= 7) ? `filtroPrioridade${num}` : null,
            boaspraticas: num >= 4 && num <=6 ? `filtroBoasPraticas${num}` : null
          };
          const todosFiltros = { equipe: {idx:1}, microarea: {idx:2}, ...filtros };
          Object.keys(todosFiltros).forEach(ch => {
            const id = ids[ch];
            if (id && document.getElementById(id)) {
              const valores = [...new Set(dados.map(r => r[todosFiltros[ch].idx]).filter(Boolean))].sort();
              const $s = $(`#${id}`).empty();
              valores.forEach(v => $s.append(`<option value="${v}">${v}</option>`));
              $s.select2({ placeholder: ch==='microarea'?'Todas as microáreas':'Todas', allowClear:true });
            }
          });
          [
            {el:`#${ids.equipe}`, col:1},
            {el:`#${ids.microarea}`, col:2},
            ...(filtros.status ? [{el:`#${ids.status}`, col:filtros.status.idx}] : []),
            ...(filtros.quadrimestre ? [{el:`#${ids.quadrimestre}`, col:filtros.quadrimestre.idx}] : []),
            ...(filtros.prioridade ? [{el:`#${ids.prioridade}`, col:filtros.prioridade.idx}] : []),
            ...(filtros.boaspraticas ? [{el:`#${ids.boaspraticas}`, col:filtros.boaspraticas.idx}] : [])
          ].forEach(f => {
            $(f.el).off('change.filter').on('change.filter', function() {
              const v = $(this).val() || [];
              const regex = v.length ? '^(' + v.map(x=>x.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|') + ')$' : '';
              tabela.column(f.col).search(regex, true, false).draw();
            });
          });
          // FILTRO ESPECIAL DE IDADE GESTACIONAL (≥ e ≤) - apenas aba 3
          if (num === 3) {
            const $maior = $('#idadeGestMaior');
            const $menor = $('#idadeGestMenor');
            const aplicarFiltroIdade = $.fn.dataTable.util.throttle(function () {
              const maior = $maior.val() ? parseInt($maior.val(), 10) : null;
              const menor = $menor.val() ? parseInt($menor.val(), 10) : null;
              while ($.fn.dataTable.ext.search.length > 0) {
                $.fn.dataTable.ext.search.pop();
              }
              $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                if (settings.nTable !== tabela.table().node()) return true;
                const valorStr = data[6] ? data[6].toString().trim() : '';
                if (!valorStr || isNaN(valorStr)) return false;
                const valor = parseInt(valorStr, 10);
                if (maior !== null && valor < maior) return false;
                if (menor !== null && valor > menor) return false;
                return true;
              });
              tabela.draw();
            }, 300);
            $maior.off('keyup change').on('keyup change', aplicarFiltroIdade);
            $menor.off('keyup change').on('keyup change', aplicarFiltroIdade);
          }
          // Botão PDF
          document.getElementById(`btnPdf${num}`).onclick = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({orientation: 'landscape', unit: 'mm', format: 'a4'});
            const equipeSel = $(`#${ids.equipe}`).val() || [];
            const microSel = $(`#${ids.microarea}`).val() || [];
            const titulos = ['','Desenv. Infantil (exceto vacinas)','Desenv. Infantil (vacinas)','Gestação e Puerpério','Hipertensão','Diabetes','Saúde da Mulher','Pessoa Idosa'];
            let titulo = titulos[num];
            if (equipeSel.length === 1) titulo += ` - Equipe ${equipeSel[0]}`;
            else if (equipeSel.length > 1) titulo += ` - Equipes ${equipeSel.join(', ')}`;
            if (microSel.length) titulo += (equipeSel.length ? ' | ' : ' - ') + `Microárea ${microSel.join(', ')}`;
            doc.setFontSize(14);
            doc.text(titulo.length > 110 ? titulo.substring(0,107)+'...' : titulo, 14, 25);
            const rows = tabela.rows({search:'applied'}).data().toArray();
            if (!rows.length) return alert('Nenhum registro encontrado');
            const incluirEquipe = equipeSel.length !== 1;
            const head = ['Nº'];
            if (incluirEquipe) head.push(cabecalhosReais[0]);
            head.push(cabecalhosReais[1]);
            head.push(...cabecalhosReais.slice(2));
            const body = rows.map((r, i) => {
              const linha = [(i + 1).toString()];
              if (incluirEquipe) linha.push(r[1]);
              linha.push(r[2]);
              for (let j = 3; j < r.length; j++) linha.push(r[j] || '');
              return linha;
            });
            doc.autoTable({
              head: [head],
              body: body,
              startY: 35,
              theme: 'striped',
              styles: { halign: 'center', valign: 'middle', fontSize: 7.5 },
              headStyles: { fillColor: [0, 123, 255], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center', valign: 'middle' },
              margin: { top: 12, bottom:12, left:8, right:8 },
              columnStyles: { 0: { cellWidth: 12 } }
            });
            let nomeArquivo = titulos[num].toLowerCase().replace(/[^a-z0-9]/gi,'-');
            if (equipeSel.length === 1) nomeArquivo += `-eq${equipeSel[0]}`;
            else if (equipeSel.length > 1) nomeArquivo += `-varias-equipes`;
            doc.save(nomeArquivo + '.pdf');
          };
        }
      });
    }
    document.addEventListener('DOMContentLoaded', () => {
      criarTabela(1, 4, 5, 14, {status:{idx:12}, quadrimestre:{idx:14}});
      criarTabela(2, 4, 5, 12, {status:{idx:11}, quadrimestre:{idx:12}});
      criarTabela(3, 4, 5, 18, {idadeGestacional: {idx:6}});
      criarTabela(4, 3, 4, 11, {prioridade:{idx:10}, boaspraticas:{idx:11}});
      criarTabela(5, 3, 4, 13, {prioridade:{idx:12}, boaspraticas:{idx:13}});
      criarTabela(6, 3, 4, 11, {prioridade:{idx:10}, boaspraticas:{idx:11}});
      criarTabela(7, 3, 4, 10, {prioridade:{idx:10}});  <!-- B=1 (Equipe), C=2 (Microárea), K=10 (Prioridade) -->
    });
  </script>
</body>
</html>
