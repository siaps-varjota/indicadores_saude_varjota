<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Indicadores de Saúde de Varjota</title>

  <!-- Bibliotecas -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    body {
      font-family: Nunito, sans-serif;
      margin: 16px;
      font-size: 14px;
    }

    h2 { text-align: center; }

    .tab-buttons { margin-bottom: 14px; }

    .tab-button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px 4px 0 0;
      cursor: pointer;
      margin-right: 5px;
    }
    .tab-button:hover { background-color: #0056b3; }
    .tab-button.active { background-color: #0056b3; }

    .tab-content {
      display: none;
      padding: 16px;
      border: 1px solid #ccc;
      border-radius: 0 4px 4px 4px;
    }
    .tab-content.active { display: block; }

    /* Filtros */
    select {
      margin-bottom: 15px;
      padding: 5px;
      margin-right: 10px;
    }

    table {
      width: 100%;
      border: 1px solid white;
      text-align: center;
    }

    button {
      margin-left: 10px;
      padding: 8px 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background-color: #0056b3; }

    #erroPdf, #erroPdf2, #erroPdf3 {
      color: red;
      margin-top: 10px;
      display: none;
    }

    /* Search ampliado e abaixo dos filtros */
    .dataTables_filter {
      width: 100% !important;
      text-align: left !important;
      margin-bottom: 12px !important;
      margin-top: 10px !important;
    }

    .dataTables_filter input {
      width: 300px !important;
      max-width: 100% !important;
      padding: 6px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<h2>Indicadores de Saúde de Varjota</h2>

<!-- Botões das abas -->
<div class="tab-buttons">
  <button class="tab-button active" onclick="openTab('tab1')">Desenvolvimento Infantil - exceto vacinas</button>
  <button class="tab-button" onclick="openTab('tab2')">Desenvolvimento Infantil - vacinas</button>
  <button class="tab-button" onclick="openTab('tab3')">Gestação e Puerpério</button>
</div>

<!-- ABA 1 -->
<div id="tab1" class="tab-content active">

  <label>Filtrar por Equipe:</label>
  <select id="filtroEquipe"><option value="">Todas</option></select>

  <label>Filtrar por Status:</label>
  <select id="filtroStatus1"><option value="">Todos</option></select>

  <label>Filtrar por Quadrimestre:</label>
  <select id="filtroQuadrimestre1"><option value="">Todos</option></select>

  <button id="btnPdf1">Gerar PDF</button>
  <div id="erroPdf"></div>

  <!-- Search aparece aqui -->
  <div class="search-container"></div>

  <table id="tabela1" class="display">
    <thead><tr id="cabecalho1"></tr></thead>
    <tbody></tbody>
  </table>

</div>

<!-- ABA 2 -->
<div id="tab2" class="tab-content">

  <label>Filtrar por Equipe:</label>
  <select id="filtroEquipe2"><option value="">Todas</option></select>

  <label>Filtrar por Status:</label>
  <select id="filtroStatus2"><option value="">Todos</option></select>

  <label>Filtrar por Quadrimestre:</label>
  <select id="filtroQuadrimestre2"><option value="">Todos</option></select>

  <button id="btnPdf2">Gerar PDF</button>
  <div id="erroPdf2"></div>

  <!-- Search aparece aqui -->
  <div class="search-container"></div>

  <table id="tabela2" class="display">
    <thead><tr id="cabecalho2"></tr></thead>
    <tbody></tbody>
  </table>

</div>

<!-- ABA 3 -->
<div id="tab3" class="tab-content">

  <label>Filtrar por Equipe:</label>
  <select id="filtroEquipe3"><option value="">Todas</option></select>

  <button id="btnPdf3">Gerar PDF</button>
  <div id="erroPdf3"></div>

  <!-- Search aparece aqui -->
  <div class="search-container"></div>

  <table id="tabela3" class="display">
    <thead><tr id="cabecalho3"></tr></thead>
    <tbody></tbody>
  </table>

</div>

<script>

// ----------------------
// Abas
// ----------------------
function openTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

  document.getElementById(tabId).classList.add('active');
  document.querySelector(`[onclick="openTab('${tabId}')"]`).classList.add('active');
}

document.addEventListener('DOMContentLoaded', function () {

  // CSVs
  const csvUrl1 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJk3K_1DtxtxvBx5UuRIbsl_OGzNA9AMMx3TbacImInVTl759ziDlxBK0nlwZg1J_iKxjktwvI5FaH/pub?gid=1142482515&single=true&output=csv&t=" + new Date().getTime();
  const csvUrl2 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJk3K_1DtxtxvBx5UuRIbsl_OGzNA9AMMx3TbacImInVTl759ziDlxBK0nlwZg1J_iKxjktwvI5FaH/pub?gid=1899832726&single=true&output=csv&t=" + new Date().getTime();
  const csvUrl3 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSA7ZEnYITSAdJO8T5LvvnDewjPeqMT57kDv_oSeuFUUznKI3FQ5pGg2Ic34k4ZShbWtONP-dvJOABQ/pub?gid=1768767677&single=true&output=csv&t=" + new Date().getTime();

  // ================================
  // TABELA 1
  // ================================
  Papa.parse(csvUrl1, {
    download: true,
    skipEmptyLines: true,
    complete: function (results) {

      let cabecalhoGlobal1 = ['Nº', ...results.data[4].slice(1, 15)];
      let dados1 = results.data.slice(5);

      // Normalização
      dados1 = dados1.map(r => {
        r[13] = r[13] ? r[13].normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase() : '';
        r[14] = r[14] ? r[14].normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase() : '';
        return r;
      });

      // Cabeçalho
      let cab1 = document.getElementById("cabecalho1");
      cabecalhoGlobal1.forEach(c => {
        let th = document.createElement("th");
        th.textContent = c;
        cab1.appendChild(th);
      });

      // Corpo
      let tb = document.querySelector("#tabela1 tbody");
      dados1.forEach(r => {
        if (r.length > 14) {
          let tr = document.createElement("tr");
          tr.innerHTML = `
            <td></td>
            <td>${r[1] || ''}</td><td>${r[2] || ''}</td><td>${r[3] || ''}</td><td>${r[4] || ''}</td>
            <td>${r[5] || ''}</td><td>${r[6] || ''}</td><td>${r[7] || ''}</td><td>${r[8] || ''}</td>
            <td>${r[9] || ''}</td><td>${r[10] || ''}</td><td>${r[11] || ''}</td><td>${r[12] || ''}</td>
            <td>${r[13] || ''}</td><td>${r[14] || ''}</td>
          `;
          tb.appendChild(tr);
        }
      });

      let tabela1 = $('#tabela1').DataTable({
        "pageLength": 10,
        "dom": '<"top-perm f">rtip',   <!-- SEARCH DEBAIXO DOS FILTROS -->
        "drawCallback": function () {
          let api = this.api();
          api.rows({ page: 'current' }).nodes()
            .each((row, i) => $(row).find('td:first').text(i + 1 + api.page.info().start));
        }
      });

      // Move search para o container logo abaixo dos filtros
      $("#tab1 .search-container").append($("#tab1 .dataTables_filter"));

      // Filtros
      let filtroEquipe1 = document.getElementById("filtroEquipe");
      Array.from(new Set(dados1.map(r => r[1]))).sort()
        .filter(v => v).forEach(eq => {
          filtroEquipe1.innerHTML += `<option>${eq}</option>`;
        });

      let filtroStatus1 = document.getElementById("filtroStatus1");
      Array.from(new Set(dados1.map(r => r[13]))).sort()
        .filter(v => v).forEach(st => {
          filtroStatus1.innerHTML += `<option>${st}</option>`;
        });

      let filtroQuadr1 = document.getElementById("filtroQuadrimestre1");
      Array.from(new Set(dados1.map(r => r[14]))).sort()
        .filter(v => v).forEach(q => {
          filtroQuadr1.innerHTML += `<option>${q}</option>`;
        });

      function applyFilters1() {
        tabela1.column(1).search(filtroEquipe1.value ? `^${filtroEquipe1.value}$` : '', true, false);
        tabela1.column(13).search(filtroStatus1.value ? `^${filtroStatus1.value}$` : '', true, false);
        tabela1.column(14).search(filtroQuadr1.value ? `^${filtroQuadr1.value}$` : '', true, false);
        tabela1.draw();
      }

      filtroEquipe1.onchange = applyFilters1;
      filtroStatus1.onchange = applyFilters1;
      filtroQuadr1.onchange = applyFilters1;
    }
  });

  // ================================
  // TABELA 2  (mesmo padrão da 1)
  // ================================
  Papa.parse(csvUrl2, {
    download: true,
    skipEmptyLines: true,
    complete: function (results) {

      let cabecalhoGlobal2 = ['Nº', ...results.data[4].slice(1, 13)];
      let dados2 = results.data.slice(5);

      dados2 = dados2.map(r => {
        r[11] = r[11] ? r[11].normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase() : '';
        r[12] = r[12] ? r[12].normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase() : '';
        return r;
      });

      let cab2 = document.getElementById("cabecalho2");
      cabecalhoGlobal2.forEach(c => {
        let th = document.createElement("th");
        th.textContent = c;
        cab2.appendChild(th);
      });

      let tb = document.querySelector("#tabela2 tbody");
      dados2.forEach(r => {
        if (r.length > 12) {
          let tr = document.createElement("tr");
          tr.innerHTML = `
            <td></td>
            <td>${r[1] || ''}</td><td>${r[2] || ''}</td><td>${r[3] || ''}</td><td>${r[4] || ''}</td>
            <td>${r[5] || ''}</td><td>${r[6] || ''}</td><td>${r[7] || ''}</td><td>${r[8] || ''}</td>
            <td>${r[9] || ''}</td><td>${r[10] || ''}</td><td>${r[11] || ''}</td><td>${r[12] || ''}</td>
          `;
          tb.appendChild(tr);
        }
      });

      let tabela2 = $('#tabela2').DataTable({
        "pageLength": 10,
        "dom": '<"top-perm f">rtip',
        "drawCallback": function () {
          let api = this.api();
          api.rows({ page: 'current' }).nodes()
            .each((row, i) => $(row).find('td:first').text(i + 1 + api.page.info().start));
        }
      });

      $("#tab2 .search-container").append($("#tab2 .dataTables_filter"));

      // Filtros
      let filtroEquipe2 = document.getElementById("filtroEquipe2");
      Array.from(new Set(dados2.map(r => r[1]))).sort()
        .filter(v => v).forEach(eq => filtroEquipe2.innerHTML += `<option>${eq}</option>`);

      let filtroStatus2 = document.getElementById("filtroStatus2");
      Array.from(new Set(dados2.map(r => r[11]))).sort()
        .filter(v => v).forEach(st => filtroStatus2.innerHTML += `<option>${st}</option>`);

      let filtroQuadr2 = document.getElementById("filtroQuadrimestre2");
      Array.from(new Set(dados2.map(r => r[12]))).sort()
        .filter(v => v).forEach(q => filtroQuadr2.innerHTML += `<option>${q}</option>`);

      function applyFilters2() {
        tabela2.column(1).search(filtroEquipe2.value ? `^${filtroEquipe2.value}$` : '', true, false);
        tabela2.column(11).search(filtroStatus2.value ? `^${filtroStatus2.value}$` : '', true, false);
        tabela2.column(12).search(filtroQuadr2.value ? `^${filtroQuadr2.value}$` : '', true, false);
        tabela2.draw();
      }

      filtroEquipe2.onchange = applyFilters2;
      filtroStatus2.onchange = applyFilters2;
      filtroQuadr2.onchange = applyFilters2;

    }
  });

  // ================================
  // TABELA 3  (mesmo padrão)
  // ================================
  Papa.parse(csvUrl3, {
    download: true,
    skipEmptyLines: true,
    complete: function (results) {

      let cabecalhoGlobal3 = ['Nº', ...results.data[4].slice(1, 19)];
      let dados3 = results.data.slice(5);

      let cab3 = document.getElementById("cabecalho3");
      cabecalhoGlobal3.forEach(c => {
        let th = document.createElement("th");
        th.textContent = c;
        cab3.appendChild(th);
      });

      let tb = document.querySelector("#tabela3 tbody");
      dados3.forEach(r => {
        if (r.length > 18) {
          let tr = document.createElement("tr");
          tr.innerHTML = `
            <td></td>
            <td>${r[1] || ''}</td><td>${r[2] || ''}</td><td>${r[3] || ''}</td><td>${r[4] || ''}</td>
            <td>${r[5] || ''}</td><td>${r[6] || ''}</td><td>${r[7] || ''}</td><td>${r[8] || ''}</td>
            <td>${r[9] || ''}</td><td>${r[10] || ''}</td><td>${r[11] || ''}</td><td>${r[12] || ''}</td>
            <td>${r[13] || ''}</td><td>${r[14] || ''}</td><td>${r[15] || ''}</td><td>${r[16] || ''}</td>
            <td>${r[17] || ''}</td><td>${r[18] || ''}</td>
          `;
          tb.appendChild(tr);
        }
      });

      let tabela3 = $('#tabela3').DataTable({
        "pageLength": 10,
        "dom": '<"top-perm f">rtip',
        "drawCallback": function () {
          let api = this.api();
          api.rows({ page: 'current' }).nodes()
            .each((row, i) => $(row).find('td:first').text(i + 1 + api.page.info().start));
        }
      });

      $("#tab3 .search-container").append($("#tab3 .dataTables_filter"));

      // Filtro simples
      let filtroEquipe3 = document.getElementById("filtroEquipe3");
      Array.from(new Set(dados3.map(r => r[1]))).sort()
        .filter(v => v).forEach(eq => filtroEquipe3.innerHTML += `<option>${eq}</option>`);

      filtroEquipe3.onchange = () => {
        tabela3.column(1).search(filtroEquipe3.value ? `^${filtroEquipe3.value}$` : '', true, false).draw();
      };
    }
  });

});

</script>

</body>
</html>
