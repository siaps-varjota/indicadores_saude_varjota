<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Indicadores de Saúde de Varjota</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
  <!-- jsPDF + autoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { font-family: Nunito, sans-serif; margin: 16px; font-size: 14px; }
    h2 { text-align: center; color: #2c3e50; }
    .tab-buttons { margin-bottom: 14px; text-align: center; }
    .tab-button {
      padding: 10px 20px; background-color: #007bff; color: white;
      border: none; border-radius: 4px 4px 0 0; cursor: pointer; margin: 0 5px;
    }
    .tab-button:hover { background-color: #0056b3; }
    .tab-button.active { background-color: #0056b3; }
    .tab-content { display: none; padding: 20px; border: 1px solid #ccc; border-radius: 0 4px 4px 4px; background: #f9f9f9; }
    .tab-content.active { display: block; }
    select, button { margin: 5px; padding: 8px; font-size: 14px; }
    button { background-color: #28a745; border: none; border-radius: 4px; color: white; cursor: pointer; }
    button:hover { background-color: #218838; }
    .erro { color: red; font-weight: bold; margin-top: 10px; display: none; }
    table { width: 100%; margin-top: 10px; }
    th, td { text-align: center; padding: 6px; font-size: 12px; }
  </style>
</head>
<body>
  <h2>Indicadores de Saúde de Varjota</h2>

  <div class="tab-buttons">
    <button class="tab-button active" onclick="openTab('tab1')">Desenv. Infantil (exceto vacinas)</button>
    <button class="tab-button" onclick="openTab('tab2')">Desenv. Infantil (vacinas)</button>
    <button class="tab-button" onclick="openTab('tab3')">Gestação e Puerpério</button>
    <button class="tab-button" onclick="openTab('tab4')">Hipertensão</button>
    <button class="tab-button" onclick="openTab('tab5')">Diabetes</button>
  </div>

  <!-- Aba 1 -->
  <div id="tab1" class="tab-content active">
    <label>Equipe: <select id="filtroEquipe"><option value="">Todas</option></select></label>
    <label>Status: <select id="filtroStatus1"><option value="">Todos</option></select></label>
    <label>Quadrimestre: <select id="filtroQuadrimestre1"><option value="">Todos</option></select></label>
    <button id="btnPdf1">Gerar PDF</button>
    <div id="erroPdf" class="erro"></div>
    <table id="tabela1" class="display"><thead><tr id="cabecalho1"></tr></thead><tbody></tbody></table>
  </div>

  <!-- Aba 2 -->
  <div id="tab2" class="tab-content">
    <label>Equipe: <select id="filtroEquipe2"><option value="">Todas</option></select></label>
    <label>Status: <select id="filtroStatus2"><option value="">Todos</option></select></label>
    <label>Quadrimestre: <select id="filtroQuadrimestre2"><option value="">Todos</option></select></label>
    <button id="btnPdf2">Gerar PDF</button>
    <div id="erroPdf2" class="erro"></div>
    <table id="tabela2" class="display"><thead><tr id="cabecalho2"></tr></thead><tbody></tbody></table>
  </div>

  <!-- Aba 3 -->
  <div id="tab3" class="tab-content">
    <label>Equipe: <select id="filtroEquipe3"><option value="">Todas</option></select></label>
    <button id="btnPdf3">Gerar PDF</button>
    <div id="erroPdf3" class="erro"></div>
    <table id="tabela3" class="display"><thead><tr id="cabecalho3"></tr></thead><tbody></tbody></table>
  </div>

  <!-- Aba 4 - Hipertensão -->
  <div id="tab4" class="tab-content">
    <label>Equipe: <select id="filtroEquipe4"><option value="">Todas</option></select></label>
    <label>Prioridade: <select id="filtroPrioridade4"><option value="">Todas</option></select></label>
    <label>Boas Práticas: <select id="filtroBoasPraticas4"><option value="">Todas</option></select></label>
    <button id="btnPdf4">Gerar PDF</button>
    <div id="erroPdf4" class="erro"></div>
    <table id="tabela4" class="display"><thead><tr id="cabecalho4"></tr></thead><tbody></tbody></table>
  </div>

  <!-- Aba 5 - Diabetes -->
  <div id="tab5" class="tab-content">
    <label>Equipe: <select id="filtroEquipe5"><option value="">Todas</option></select></label>
    <label>Prioridade: <select id="filtroPrioridade5"><option value="">Todas</option></select></label>
    <label>Boas Práticas: <select id="filtroBoasPraticas5"><option value="">Todas</option></select></label>
    <button id="btnPdf5">Gerar PDF</button>
    <div id="erroPdf5" class="erro"></div>
    <table id="tabela5" class="display"><thead><tr id="cabecalho5"></tr></thead><tbody></tbody></table>
  </div>

  <script>
    function openTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`[onclick="openTab('${tabId}')"]`).classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', function () {
      const urls = {
        1: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJk3K_1DtxtxvBx5UuRIbsl_OGzNA9AMMx3TbacImInVTl759ziDlxBK0nlwZg1J_iKxjktwvI5FaH/pub?gid=1142482515&single=true&output=csv",
        2: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJk3K_1DtxtxvBx5UuRIbsl_OGzNA9AMMx3TbacImInVTl759ziDlxBK0nlwZg1J_iKxjktwvI5FaH/pub?gid=1899832726&single=true&output=csv",
        3: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSA7ZEnYITSAdJO8T5LvvnDewjPeqMT57kDv_oSeuFUUznKI3FQ5pGg2Ic34k4ZShbWtONP-dvJOABQ/pub?gid=1768767677&single=true&output=csv",
        4: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT9k_e_-jlJbu3GvtHBhvCfuUbuC7l85MV_jjZRnbsd3lIqmoKF2pLhGl1JnSfziVXze5zkGCXdPb2n/pub?output=csv",
        5: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSbfV1Kc6st6COoy-FxrbfnC_Ac3bxobCVY_-HXj0oyXNnVo7uVld2VVJh7gAhXAPGHXlZGutzjivjP/pub?gid=1534038569&single=true&output=csv"
      };

      // Função genérica para criar tabela e PDF
      function criarTabela(num, headerRowIdx, dataStartIdx, colunasFim, filtros = {}) {
        Papa.parse(urls[num] + "&t=" + Date.now(), {
          download: true,
          skipEmptyLines: true,
          complete: function (res) {
            const cabecalhoGlobal = ['Nº', ...res.data[headerRowIdx].slice(1, colunasFim + 1)];
            let dados = res.data.slice(dataStartIdx);

            // Normalização de colunas de filtro
            if (filtros.equipe) dados = dados.map(r => { r[filtros.equipe.idx] = (r[filtros.equipe.idx] || '').trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase(); return r; });
            if (filtros.status) dados = dados.map(r => { r[filtros.status.idx] = (r[filtros.status.idx] || '').trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase(); return r; });
            if (filtros.quadrimestre) dados = dados.map(r => { r[filtros.quadrimestre.idx] = (r[filtros.quadrimestre.idx] || '').trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase(); return r; });
            if (filtros.prioridade) dados = dados.map(r => { r[filtros.prioridade.idx] = (r[filtros.prioridade.idx] || '').trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase(); return r; });
            if (filtros.boaspraticas) dados = dados.map(r => { r[filtros.boaspraticas.idx] = (r[filtros.boaspraticas.idx] || '').trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase(); return r; });

            // Cabeçalho
            document.getElementById(`cabecalho${num}`).innerHTML = '';
            cabecalhoGlobal.forEach(h => {
              let th = document.createElement('th');
              th.textContent = h || 'Sem Nome';
              document.getElementById(`cabecalho${num}`).appendChild(th);
            });

            // Corpo
            const tbody = document.querySelector(`#tabela${num} tbody`);
            tbody.innerHTML = '';
            dados.forEach(row => {
              if (row.length >= colunasFim) {
                let tr = document.createElement('tr');
                let tds = '<td></td>'; // Nº
                for (let i = 1; i <= colunasFim; i++) tds += `<td>${row[i] || ''}</td>`;
                tr.innerHTML = tds;
                tbody.appendChild(tr);
              }
            });

            // DataTable com numeração dinâmica
            const tabela = $(`#tabela${num}`).DataTable({
              pageLength: 10,
              destroy: true,
              drawCallback: function () {
                this.api().rows({ page: 'current' }).nodes().each((row, i) => {
                  $(row).find('td:first').text(i + 1 + this.api().page.info().start);
                });
              }
            });

            // Preencher filtros
            if (filtros.equipe) preencherSelect(`filtroEquipe${num === 1 || num === 2 ? '' : num}`, dados.map(r => r[filtros.equipe.idx]));
            if (filtros.status) preencherSelect(`filtroStatus${num}`, dados.map(r => r[filtros.status.idx]));
            if (filtros.quadrimestre) preencherSelect(`filtroQuadrimestre${num}`, dados.map(r => r[filtros.quadrimestre.idx]));
            if (filtros.prioridade) preencherSelect(`filtroPrioridade${num}`, dados.map(r => r[filtros.prioridade.idx]));
            if (filtros.boaspraticas) preencherSelect(`filtroBoasPraticas${num}`, dados.map(r => r[filtros.boaspraticas.idx]));

            function preencherSelect(id, valores) {
              const unique = [...new Set(valores.filter(v => v))].sort();
              const select = document.getElementById(id);
              select.innerHTML = '<option value="">Todas</option>';
              unique.forEach(v => select.add(new Option(v, v)));
            }

            // Aplicar filtros
            const filtrosEls = [];
            if (filtros.equipe) filtrosEls.push({ el: `#filtroEquipe${num === 1 || num === 2 ? '' : num}`, col: filtros.equipe.idx });
            if (filtros.status) filtrosEls.push({ el: `#filtroStatus${num}`, col: filtros.status.idx });
            if (filtros.quadrimestre) filtrosEls.push({ el: `#filtroQuadrimestre${num}`, col: filtros.quadrimestre.idx });
            if (filtros.prioridade) filtrosEls.push({ el: `#filtroPrioridade${num}`, col: filtros.prioridade.idx });
            if (filtros.boaspraticas) filtrosEls.push({ el: `#filtroBoasPraticas${num}`, col: filtros.boaspraticas.idx });

            filtrosEls.forEach(f => {
              document.querySelector(f.el).addEventListener('change', () => {
                filtrosEls.forEach(ff => {
                  const val = document.querySelector(ff.el).value;
                  tabela.column(ff.col).search(val ? '^' + val + '$' : '', true, false);
                });
                tabela.draw();
              });
            });

            // Botão PDF
            document.getElementById(`btnPdf${num}`).onclick = function () {
              if (typeof window.jspdf === 'undefined') {
                document.getElementById(`erroPdf${num}`).textContent = 'Erro: jsPDF não carregou.';
                document.getElementById(`erroPdf${num}`).style.display = 'block';
                return;
              }
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

              const equipe = filtros.equipe ? (document.getElementById(`filtroEquipe${num === 1 || num === 2 ? '' : num}`).value || 'todas_equipes') : 'todas_equipes';
              const tituloBase = {
                1: "Desenvolvimento Infantil - exceto vacinas",
                2: "Desenvolvimento Infantil - vacinas",
                3: "Gestação e Puerpério",
                4: "Hipertensão",
                5: "Diabetes"
              }[num];
              doc.text(equipe === 'todas_equipes' ? tituloBase : `${tituloBase} - ${equipe}`, 14, 20);

              const rows = tabela.rows({ search: 'applied' }).data().toArray();
              if (rows.length === 0) {
                document.getElementById(`erroPdf${num}`).textContent = 'Nenhum dado para gerar PDF.';
                document.getElementById(`erroPdf${num}`).style.display = 'block';
                return;
              }

              const head = equipe === 'todas_equipes' ? cabecalhoGlobal : ['Nº', ...cabecalhoGlobal.slice(2)];
              const body = rows.map((r, i) => {
                const linha = [(i + 1).toString()];
                if (equipe === 'todas_equipes') linha.push(r[1]);
                for (let j = 2; j < r.length; j++) linha.push(r[j] || '');
                return linha;
              });

              doc.autoTable({
                head: [head],
                body: body,
                startY: 30,
                theme: 'striped',
                styles: { fontSize: 7, halign: 'center' },
                headStyles: { fillColor: [41, 128, 185] }
              });

              const nomeArquivo = `${tituloBase.toLowerCase().replace(/ /g, '-')}-${equipe}${filtros.status ? '-' + (document.getElementById(`filtroStatus${num}`).value || 'todos') : ''}${filtros.quadrimestre ? '-' + (document.getElementById(`filtroQuadrimestre${num}`).value || 'todos') : ''}${filtros.prioridade ? '-' + (document.getElementById(`filtroPrioridade${num}`).value || 'todas') : ''}${filtros.boaspraticas ? '-' + (document.getElementById(`filtroBoasPraticas${num}`).value || 'todas') : ''}.pdf`;
              doc.save(nomeArquivo);
            };
          }
        });
      }

      // Criar todas as tabelas
      criarTabela(1, 4, 5, 14, { equipe: { idx: 1 }, status: { idx: 13 }, quadrimestre: { idx: 14 } });
      criarTabela(2, 4, 5, 12, { equipe: { idx: 1 }, status: { idx: 11 }, quadrimestre: { idx: 12 } });
      criarTabela(3, 4, 5, 18, { equipe: { idx: 1 } });
      criarTabela(4, 3, 4, 11, { equipe: { idx: 1 }, prioridade: { idx: 10 }, boaspraticas: { idx: 11 } });
      criarTabela(5, 3, 4, 13, { equipe: { idx: 1 }, prioridade: { idx: 12 }, boaspraticas: { idx: 13 } });
    });
  </script>
</body>
</html>
